---
title: "GenSEM Factor Analysis"
author: "Ellen Martin"
date: "11/02/2022"
output:
  pdf_document: default
  html_document: default
---

## GenSEM Factor Analyisis

Factor Analysis:
- exploratory factor analysis on no_loneliness_odd

- confirmatory factor analysis on no_loneliness_even

- selection of the best fitting model

- Specification of GenomicSEM model with loneliness, based on best-fitting factor structure

##Setting WD's and Getting Libraries

```{r setup}
setwd("C:\\Users\\ellen\\OneDrive\\BSc Psych\\Publication Genetics\\GSEM2") #setting WD locally

#libraries
library(Matrix) #for smoothing the data
library(GenomicSEM) #for confirmatory factor analysis
library(psych) #for factor analysis
library(factoextra) #for factor analysis
library(nFactors) #for factor analysis

#data
load("no_loneliness_odd.RData")

#smoothing the data
covstruc <- no_loneliness_odd$S #taking the S-matrix from the LDSC output
corrstruc <- cov2cor(covstruc) #converting to a correlation matrix for factor analysis
corrstruc_smooth <- as.matrix((nearPD(corrstruc))$mat) #smoothing the correlation matrix to nearest positive definite

```

## Scree Plot

Using a scree plot and eigenvalues to suggest the number of factors to retain.

```{r scree}
ev <- eigen(corrstruc_smooth) # get eigenvalues
ap <- parallel(subject=nrow(corrstruc_smooth),var=ncol(corrstruc_smooth),
               rep=100,cent=.05)
nS <- nScree(x=ev$values, aparallel=ap$eigen$qevpea)
plotnScree(nS) #plots scree

#alternate visualisation of scree plot
res.pca <- prcomp(corrstruc_smooth, scale = TRUE)
screeplot(res.pca, type = "lines")
fviz_eig(res.pca)
get_eigenvalue(res.pca) 
fviz_screeplot(res.pca)

#suggests the retention of 1-4 factors
```

## Exploratory Factor Analysis

Conducted specifying 1 - 4 factors to retain.

```{r efa}

#1 factor
fit1 <- fa(corrstruc_smooth, nfactors = 1, rotate = "promax", fm = "uls")
fit1$loadings

#factor structure
# 'F1 =~ ADHD + CAN + PTSD + SMK + MDD
#  F2 =~ ANX + BIP + MDD + SCZ


#2 factor
fit2 <- fa(corrstruc_smooth, nfactors = 2, rotate = "promax", fm = "uls")
fit2$loadings

#factor structure
# 'F1 =~ ADHD + CAN + PTSD + SMK + MDD
#  F2 =~ ANX + BIP + MDD + SCZ


#3 factor
fit3 <- fa(corrstruc_smooth, nfactors = 3, rotate = "promax", fm = "uls")
fit3$loadings

#factor structure
# 'F1 =~ ADHD + ANX + ASD + MDD + PTSD
#  F2 =~ ALC + CAN + SMK
#  F3 =~ BIP + SCZ


#4 factor

fit4 <- fa(corrstruc_smooth, nfactors = 4, rotate="promax", fm = "uls")
fit4$loadings

#factor structure
# 'F1 =~ ADHD + ASD + MDD + PTSD
#  F2 =~ ANX + MDD
#  F3 =~ BIP + SCZ
#  F4 =~ ALC + CAN + SMK
```

## Confirmatory Factor Analysis

Conducted using GenomicSEM, using the EVEN data to prevent overfitting
- Results suggest that a 3 factor solution achieves the best fit

```{r cfa}
setwd("C:\\Users\\ellen\\OneDrive\\BSc Psych\\Publication Genetics\\GSEM2") #setting WD locally

load("no_loneliness_even.RData")

#1 factor (p-factor)

model1CFA <- 'F1 =~ NA*ADHD + ANX + ASD + MDD + PTSD + BIP + SCZ + CAN + SMK'
pfact<-usermodel(no_loneliness_even, estimation = "DWLS", model = model1CFA, CFIcalc = TRUE, std.lv = TRUE)
pfact$modelfit #0.15 SRMR, 0.76 CFI - poor fit
View(pfact$results)


#2 factor (bi-factor)

model2CFA <- 'F1 =~ NA*ADHD + CAN + PTSD + SMK + MDD
              F2 =~ NA*ANX + BIP + MDD + SCZ
'
fita<-usermodel(no_loneliness_even, estimation = "DWLS", model = model2CFA, CFIcalc = TRUE, std.lv = TRUE)
fita$modelfit #0.19 SRMR, 0.88 CFI - poor fit
View(fita$results)


#3 factor 
#smoking forced to one factor (F2)

model3CFA <- 'F1 =~ NA*ADHD + ANX + ASD + MDD + PTSD
              F2 =~ NA*ALC + CAN + SMK
              F3 =~ NA*BIP + SCZ
#correlations
              F1~~F2
              F1~~F3
              F2~~F3
#constraints
              CAN~~a*CAN 
              SCZ~~a*SCZ
              a > .001
'
fitb<-usermodel(no_loneliness_even, estimation = "DWLS", model = model3CFA, CFIcalc = TRUE, std.lv = TRUE)
fitb$modelfit #CFI # .93, SRMR = .10 - acceptable fit
View(fitb$results)
#write.csv(fitb$results, file = "C:\\Users\\ellen\\OneDrive\\BSc Psych\\Publication Genetics\\GSEM2\\CFA3.csv", row.names = TRUE)



#alternate 3 factor
#smoking on both F1 and F2

model3bCFA <- 'F1 =~ NA*ADHD + ANX + ASD + MDD + PTSD + SMK
               F2 =~ NA*ALC + CAN + SMK
               F3 =~ NA*BIP + SCZ

               F1~~F2
               F1~~F3
               F2~~F3

               CAN~~a*CAN
               a > .001
'
fitb2<-usermodel(no_loneliness_even, estimation = "DWLS", model = model3bCFA, CFIcalc = TRUE, std.lv = TRUE)
fitb2$modelfit #CFI # .93, SRMR = .10 - similar fit, so the first 3 factor solution is still better because it is more parismonious and aligns better with existing theory
View(fitb2$results)


#4 factor

model4CFA <-  'F1 =~ NA*ADHD + ASD + MDD + PTSD
               F2 =~ NA*ANX + MDD
               F3 =~ NA*BIP + SCZ
               F4 =~ NA*ALC + CAN + SMK

               F1 ~~ F2
               F1 ~~ F4
               F1 ~~ F3
               F2 ~~ F3
               F2 ~~ F4
               F3 ~~ F4

               CAN~~a*CAN
               MDD~~a*MDD
               a > .001
'
fitc<-usermodel(no_loneliness_even, estimation = "DWLS", model = model4CFA, CFIcalc = TRUE, std.lv = TRUE)
fitc$modelfit #0.14 SRMR, 0.96 CFI - poor fit
View(fitc$results)

```

##GenomicSEM with Loneliness
- specifying both a multivariate (adjusted) and non-adjusted model

```{r GenSEM}
setwd("C:\\Users\\ellen\\OneDrive\\BSc Psych\\Publication Genetics\\GSEM2") #setting WD locally

load("combined_covstruc.RData") #full ldsc data set used

#multivariate (adjusted), constrained model
multivar_constrained<- '
#specifying factor structure
                        F1 =~ NA*ADHD + ANX + ASD + PTSD + MDD
                        F2 =~ NA*ALC + CAN + SMK
                        F3 =~ NA*BIP + SCZ
                        
#regressed with lonelineliness, constrained to 0 for F2 and F3 because non-constrained output showed negative factor loadings from F2 and F3 to loneliness.
                        LONELINESS ~ F1 + 0*F2 + 0*F3

                        F1 ~~ F2 + F3
                        F2 ~~ F3
'

fit1constr<-usermodel(combined_covstruc, estimation = "DWLS", model = multivar_constrained, CFIcalc = TRUE, std.lv = TRUE)
View(fit1constr$results) 
fit1constr$modelfit #SRMR = .10, CFI = .94 - poorer fit than unconstrained multivar, but slightly acceptable still


#multivar model constrained and latent indicator for lone
multivar_constrained_latent<- 'F1 =~ NA*ADHD + ANX + ASD + PTSD + MDD
                               F2 =~ NA*ALC + CAN + SMK
                               F3 =~ NA*BIP + SCZ

#latent indicator for loneliness
                               LONE =~ LONELINESS
                               LONE~~1*LONE
                               LONELINESS~~0*LONELINESS

#with constraints
                               LONE ~ F1 + 0*F2 + 0*F3

                               F1 ~~ F2 + F3
                               F2 ~~ F3
'

fit1constrlatent<-usermodel(combined_covstruc, estimation = "DWLS", model = multivar_constrained_latent, CFIcalc = TRUE, std.lv = TRUE)
View(fit1constrlatent$results) 
fit1constrlatent$modelfit #same fit
#write.csv(fit1constrlatent$results, file = "C:\\Users\\ellen\\OneDrive\\BSc Psych\\Publication Genetics\\GSEM2\\multivarconstrlatent.csv", row.names = TRUE)



#unadjusted model
unadjusted_model<- 'F1 =~ NA*ADHD + ANX + ASD + PTSD + MDD
                    F2 =~ NA*ALC + CAN + SMK
                    F3 =~ NA*BIP + SCZ

#latent indicator for loneliness
                               LONE =~ LONELINESS
                               LONE~~1*LONE
                               LONELINESS~~0*LONELINESS

#with constraints
                               LONE ~~ F1 + F2 + F3
                            
'

fit2unadj<-usermodel(combined_covstruc, estimation = "DWLS", model = unadjusted_model, CFIcalc = TRUE, std.lv = TRUE)
View(fit2unadj$results) 
fit2unadj$modelfit
#write.csv(fit2unadj$results, file = "C:\\Users\\ellen\\OneDrive\\BSc Psych\\Publication Genetics\\GSEM2\\fit2unadj.csv", row.names = TRUE)
```

